---
title: "Classic_stat_tests"
author: "Anastasiia Potamoshneva"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)

```

# Инструкции

Ниже приведены семь клинических (исследовательских) гипотез. В качестве задания протестируйте их, используя соответствующие статистические критерии. Решение должно содержать все элементы алгоритма проверки статистических гипотез:

• Сформулируете нулевую и альтернативную гипотезы.
• Укажите уровень значимости α.
• Определите статистический тест (критерий) для проверки гипотезы. При необходимости аргументируйте выбор одностороннего теста. 
• Укажите критическое значение статистики (используйте распределения из материалов лекции).
• Определите наблюдаемое значение статистики.
• Оцените статистическую значимость (p-value и/или доверительный интервал).
• Оцените практическую значимость.


* Решение необходимо загружать в формате Rmd (воспроизводимый код).
** Данные для анализа необходимо генерировать самостоятельно в соответствии с каждой представленной гипотезой. По возможности используйте пакет dplyr
*** Предусмотрен мягкий дедлайн (17 ноября). В этом случае вы получите комментарии с возможностью повысить оценку. Сдача работы после жёсткого дедлайна (24 ноября) предусматривает снижение оценки (10 баллов).


# Гипотеза 1. Существует ассоциация между уровнем физической активности (бинарная переменная, физическая активность может быть 'высокой' и 'низкой') и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет. Попробуйте вариант с большими выборками (sample_size <- 100). Как изменится стратегия при малых выборках (sample_size <- 30) ? 

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки 
sample_size <- 100

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- sample(c("Высокая", "Низкая"), size = sample_size, replace = TRUE, prob = c(0.5, 0.5))

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

cardio <- ifelse(activity == "Высокая", rbinom(sample_size, 1, 0.5), rbinom(sample_size, 1, 0.6))

hyp1_large <- data.frame(activity = activity, cardio = cardio) %>% 
  mutate(activity = as.factor(activity), cardio = as.factor(cardio)) %>% 
  glimpse()

```


```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size_small <- 30

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity_small <- sample(c("Высокая", "Низкая"), size = sample_size_small, replace = TRUE, prob = c(0.5, 0.5))

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

cardio_small <- ifelse(activity_small == "Высокая", rbinom(sample_size_small, 1, 0.5), rbinom(sample_size_small, 1, 0.6))

hyp1_small <- data.frame(activity_small = activity_small, cardio_small = cardio_small) %>% 
  mutate(activity_small = as.factor(activity_small), cardio_small = as.factor(cardio_small)) %>% 
  glimpse()
    
```


## Решение

Гипотеза Н0: отсутствует ассоциация между физ.активность и частотой ССЗ

Гипотеза Н1: имеется ассоциация между физ.активность и частотой ССЗ

Установим уровень значимости α=0.05

На большой выборке используем тест хи-квадрат

Критическое значение статистики 3.84

Наблюдаемое значение статистики 3.08

Наблюдаемое значение меньше критического, следовательно, оно находится в зоне нулевой гипотезы

p-value=0.08

Следовательно, мы не можем отклонить нулевую гипотезу


На малой выборке используем точный тест Фишера (или лучше использовать один и тот же тест для сравнения большой и малой выборок в данном случае?)

Н0: ОШ получения ССЗ между группами высокой и низкой активности равно 1 (группы независимы)

Н1: ОШ получения ССЗ между группами высокой и низкой активности не равно 1 (группы зависимы)

Odds Ratio = 1.533185 (шанс не иметь ССЗ в группе высокой активности на 50% выше)

95 percent confidence interval: 0.2465195-11.9826442 (1 входит в ДИ, мы не можем отклонить нулевую гипотезу)

p-value = 0.702 (мы не можем отклонить нулевую гипотезу)

В обеих выборках не было показано, что физическая активность статистически значимо ассоциирована с частотой ССЗ. Однако бОльшая часть пациентов без ССЗ принадлежала группе высокой активности, пациенты с ССЗ были распределены по активности примерно поровну. Кроме того, на бОльшей выборке p-value был примерно в 10 раз ниже. Можно сделать предположение об ошибке второго рода, необходимо провести исследование на бОльшей выборке.

```{r large_sample}
# Создание таблиц сопряженности
table_large <- table(hyp1_large$activity, hyp1_large$cardio)
rownames(table_large) <- c("Высокая активность", "Низкая активность")
colnames(table_large) <- c("Нет ССЗ", "Есть ССЗ")
print(table_large)

# Расчет хи-квадрата
chi_large <- chisq.test(table_large)
print(chi_large)

# Расчет наблюдаемого значения хи-квадрат (замените на ваше фактическое наблюдаемое значение)
observed_chi_squared <- 3.08  # Замените на ваше реальное наблюдаемое значение

# Определение степеней свободы для распределения хи-квадрат
df <- 1  # Подстраивайте степени свободы по мере необходимости

# Создание последовательности значений x
x_values <- seq(0.01, 10, by = 0.01)  # Подстраивайте диапазон и шаг по мере необходимости

# Расчет значений PDF для распределения хи-квадрат
pdf_chi_squared <- dchisq(x_values, df)

# Квантили
quantiles <- c(0.05, 0.95)

# Расчет критических значений для распределения хи-квадрат
critical_value_lower <- qchisq(quantiles[1], df)
critical_value_upper <- qchisq(quantiles[2], df)


# Создание data frame для построения графика
pdf_data <- data.frame(x = x_values, Probability = pdf_chi_squared)

# Создание графика PDF для визуализации распределения хи-квадрат
ggplot(pdf_data, aes(x = x, y = Probability)) +
  geom_line(size = 1, color = "black") +
  labs(title = "PDF распределения хи-квадрат", x = "x", y = "Плотность вероятности") +
  theme_minimal() +
  geom_vline(xintercept = c(critical_value_lower, critical_value_upper, observed_chi_squared),
             linetype = c("solid", "solid", "dashed"),
             color = c("blue", "blue", "red"),
             size = c(2, 2, 2)) +
  annotate("text", x = critical_value_lower - 0.5, y = 0.1, label = sprintf("Q(%.3f)=%.2f", quantiles[1], critical_value_lower), hjust = 0, angle = 90) +
  annotate("text", x = critical_value_upper - 0.5, y = 0.1, label = sprintf("Q(%.3f)=%.2f", quantiles[2], critical_value_upper), hjust = 0, angle = 90) +
  annotate("text", x = observed_chi_squared - 0.5, y = 0.1, label = 'наблюдаемое', hjust = 0, angle = 90) +
  annotate("text", x = critical_value_upper - 1, y = 0.5, label = sprintf("df = %.0f", df), hjust = 0)

```

```{r small sample}


#Создание таблиц сопряженности
table_small <- table(hyp1_small$activity, hyp1_small$cardio)
rownames(table_small) <- c("Высокая активность", "Низкая активность")
colnames(table_small) <- c("Нет ССЗ", "Есть ССЗ")
print(table_small)

#Точный тест Фишера
fisher_small <- fisher.test(table_small)
print(fisher_small)
```


# Гипотеза 2. Применение нового метода лечения для пациентов с артериальной гипертензией приведет к уменьшению среднего артериального давления по сравнению с пациентами, получающими стандартное лечение.


## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки (в каждой группе)
sample_size <- 80


# В популяции c экспериментальным методом лечения средний уровень систолического артериального давления меньше (130 vs 135 mm) 
# Генерация данных для группы с новым методом лечения 
group_exp <- rnorm(sample_size, mean = 130)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group_ctrl <- rnorm(sample_size, mean = 135)  # контрольная группа

```

## Решение

Н0: средние уровни САД равны в двух группах

Н1: средний уровень САД в экспериментальной группе ниже по сравнению с контрольной

Установим уровень значимости α=0.05

Используем точный t-критерий для среднего (односторонний, так как нас интересует только снижение САД)

t = -30.829, df = 158, p-value < 2.2e-16

95 percent confidence interval:
     -Inf -4.61343
     
Отклоняем нулевую гипотезу в пользу альтернативной

В исследовании было показано статистически значимое снижение АД примерно на 5 мм рт.ст. по сравнению со стандартным методом при применении нового метода терапии.

```{r}
hyp2 <- t.test(group_exp, group_ctrl, alternative = "less", var.equal = TRUE)
print(hyp2)

observed=-30.8

# cтепени свободы
df <- 158

# значения по оси x
x_values <- seq(-4, 4, by = 0.01)  # Adjust the range and step size as needed

# PDF значения для распределения t
pdf_t <- dt(x_values, df)

# Квантили
quantiles <- c(0.05, 1)

t_critical_low <- qt(quantiles[1], df = df)
t_critical_up <-  qt(quantiles[2], df = df)

# создание базы данных
pdf_data <- data.frame(x = x_values, Probability = pdf_t)

# Создание графика PDF для визуализации стандартного нормального распределения
ggplot(pdf_data, aes(x = x)) +
  geom_line(aes(y = Probability), linewidth = 1, color = "black", linetype = "solid") +
  geom_vline(xintercept = t_critical_low, linewidth = 2, linetype = "solid", color = "blue") +
  geom_vline(xintercept = t_critical_up, linewidth = 2, linetype = "solid", color = "blue") +
  geom_vline(xintercept = observed, linewidth = 2, linetype = "dashed", color = "red") +
  annotate("text", x = t_critical_low-0.15, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[1], t_critical_low), hjust = 0, angle = 90) +
  annotate("text", x = t_critical_up-0.15, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[2], t_critical_up), hjust = 0, angle = 90) +
  annotate("text", x = observed-0.15, y = 0.2, label = 'observed', hjust = 0, angle = 90)+
  annotate("text", x = 2.5, y = 0.4, label = sprintf("df(%.0f)", df), hjust = 0)+
  labs(title = "PDF распределения Стьюдента", x = "x", y = "Плотность вероятности")


```


# Гипотеза 3. Внедрение программы реабилитации для пациентов с хронической болью в спине приведет к улучшению их физической активности (предположим что физическую активность можно оценить по шкале 0-100)

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки 
sample_size <- 30

# В популяции до реабилитации средний уровень физической активности меньше (50 vs 60) 
# Генерация данных до реабилитации
before <- rbinom(sample_size, size = 100, prob = 0.5)

# Генерация данных после реабилитации
after <- rbinom(sample_size, size = 100, prob = 0.6)  


```

## Решение

Н0: средние уровни физической активности в двух группах равны

Н1: средний уровень в группе после реабилитации выше

Установим уровень значимости α=0.05

Используем t-test для зависимых выборок (односторонняя гипотеза, так как интересует только повышение уровня активности)

t = 7.4892, df = 29, p-value = 1.483e-08

95 percent confidence interval:
 8.014708      Inf
 
Отклоняем нулевую гипотезу в пользу альтернативной (p-value<0.05, ДИ не включает ноль)

В исследовании было показано статистически значимое увеличение показателя физической активности на 10 баллов. Однако на практике это может быть незначимый результат (?)

```{r}
hyp3 <- t.test(after, before, paired = TRUE, alternative = "greater")
print(hyp3)

observed=7.5

# cтепени свободы
df <- 29

# значения по оси x
x_values <- seq(-4, 4, by = 0.01)  # Adjust the range and step size as needed

# PDF значения для распределения t
pdf_t <- dt(x_values, df)

# Квантили
quantiles <- c(0, 0.95)

t_critical_low <- qt(quantiles[1], df = df)
t_critical_up <-  qt(quantiles[2], df = df)

# создание базы данных
pdf_data <- data.frame(x = x_values, Probability = pdf_t)

# Создание графика PDF для визуализации стандартного нормального распределения
ggplot(pdf_data, aes(x = x)) +
  geom_line(aes(y = Probability), linewidth = 1, color = "black", linetype = "solid") +
  geom_vline(xintercept = t_critical_low, linewidth = 2, linetype = "solid", color = "blue") +
  geom_vline(xintercept = t_critical_up, linewidth = 2, linetype = "solid", color = "blue") +
  geom_vline(xintercept = observed, linewidth = 2, linetype = "dashed", color = "red") +
  annotate("text", x = t_critical_low-0.15, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[1], t_critical_low), hjust = 0, angle = 90) +
  annotate("text", x = t_critical_up-0.15, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[2], t_critical_up), hjust = 0, angle = 90) +
  annotate("text", x = observed-0.15, y = 0.2, label = 'observed', hjust = 0, angle = 90)+
  annotate("text", x = 2.5, y = 0.4, label = sprintf("df(%.0f)", df), hjust = 0)+
  labs(title = "PDF распределения Стьюдента", x = "x", y = "Плотность вероятности")

```

# Гипотеза 4. Применение нового метода лечения для пациентов с инфарктом миокарда увеличит долю вернувшихся к нормальной физической активности 

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 200


# В популяции экспериментального лечения вероятность нормальной физической активности больше (0.7 vs 0.65)
# Генерация данных по статусу лечение (бинарная переменная, новый метод или стандарт) в фиксированном соотношении 1:1
treatment <- sample(c("новый метод", "стандарт"), size = sample_size, replace = TRUE, prob = c(0.5, 0.5))

# Генерация данных по физической активности после лечения (бинарная переменная)
activity <- ifelse(treatment == "новый метод", rbinom(sample_size, 1, 0.7), rbinom(sample_size, 1, 0.65))

    
```

## Решение

Н0: доля пациентов с нормальной физ.активностью одинакова в обеих группах

Н1: доля пациентов с нормальной физ.активностью выше в группе нового метода лечения

Установим уровень значимости α=0.05

Используем асимптотический Z-критерий для разности долей для независимых выборок (односторонний, так как интересует только повышение активности) 

Установим уровень значимости α=0.05

X-squared = 3.3384, df = 1, p-value = 0.03384

95 percent confidence interval:
 0.01176099 1.00000000
 
 Отклоняем Н0 в пользу Н1 (p-value<0.05, ДИ не включает 0)
 
 Было показано статистически значимое повышение доли пациентов с нормальной физ.активностью после нового метода лечения (более 10%). Это может иметь практическую значимость применения этого метода.

```{r}
# Создадим таблицу сопряженности
table_activity <- table(treatment, activity)
print(table_activity)
# Посчитаем количество успехов (mx, my) и наблюдений (nx,ny) для таблицы
successes <- c(table_activity["новый метод", 2], table_activity["стандарт", 2])
observations <- c(sum(table_activity["новый метод", ]), sum(table_activity["стандарт", ]))
# Рассчитаем односторонний Z-критерий без поправки Йетса, так как большая выборка+чувствительность одностороннего теста уже выше 
z_score <- prop.test(successes, observations, alternative = "greater", correct = FALSE)
print(z_score)

observed=3.3

# Создание последовательности значений x
x_values <- seq(-4, 4, by = 0.01)

# Расчет значений Плотности Вероятности (PDF) для стандартного нормального распределения
pdf_normal <- dnorm(x_values, mean = 0, sd = 1)

# Квантили
quantiles <- c(0, 0.95)

quantile_values <- qnorm(quantiles, mean = 0, sd = 1)

# Создание данных для построения графика
pdf_data <- data.frame(x = x_values, Probability = pdf_normal)

# Создание графика PDF для визуализации стандартного нормального распределения
ggplot(pdf_data, aes(x = x)) +
  geom_line(aes(y = Probability), linewidth = 1, color = "black", linetype = "solid") +
  geom_vline(xintercept = quantile_values, linewidth = 1, linetype = "solid", color = "blue") +
  geom_vline(xintercept = observed, linewidth = 1, linetype = "dashed", color = "red") +
  annotate("text", x = quantile_values[1]-0.2, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[1], quantile_values[1]), hjust = 0, angle = 90) +
  annotate("text", x = quantile_values[2]-0.2, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[2], quantile_values[2]), hjust = 0, angle = 90) +
  annotate("text", x = observed-0.2, y = 0.1, label = 'observed', hjust = 0, angle = 90)+
  labs(title = "PDF стандартного нормального распределения", x = "x", y = "Плотность вероятности")

```

# Гипотеза 5. Применение медитации в течение 8 недель повлияет на наличие стресса (есть/нет) у лиц с высоким уровнем тревожности.

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 50

# Генерация данных до медитации (бинарная переменная) в фиксированном соотношении 1:1
before <- rbinom(sample_size, 1, 0.4)

# Генерация данных после медитации (бинарная переменная). После медитации вероятность наличия стресса меньше (0.2 vs 0.4)
after <- rbinom(sample_size, 1, 0.2)

```

## Решение

H0: Вероятность стресса до медитации равна вероятности стресса после медитации

H1: Вероятность стресса до медитации не равна вероятности стресса после медитации

Установим уровень значимости α=0.05

Используем тест Мак-Немара

McNemar's chi-squared = 16.69, df = 1, p-value = 4.402e-05

Отклоняем гипотезу Н0 в пользу Н1

В исследовании показано статистически значимое снижение уровня стресса после медитации, что может свидетельствовать о том, что этот метод может применяться у пациентов со стрессом.


```{r}

hyp5 <- tibble(before=before, after=after)
table_stress <- table(hyp5$before, hyp5$after)

rownames(table_stress) <- c("Нет стресса (до)", "Есть стресс (до)")
colnames(table_stress) <- c("Нет стресса (после)", "Есть стресс(после)")
print(table_stress)

mcnemar <- mcnemar.test(table_stress)
print(mcnemar)

```

# Гипотеза 6. Применение альтернативного метода лечения для пациентов с биполярным расстройством приведет к значимому изменению уровня симптомов депрессии по отношению к группе, прошедшей стандартное лечение (депрессию можно определить по шкале от 0 до 100, при этом исследователь должен избегать любых предположений (кроме i.i.d.)).

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки для каждой группы
sample_size <- 20


# В популяции c экспериментальным методом лечения среднее депрессии меньше (55 vs 68) 
# Генерация данных для экспериментальной группы 
group1 <- rnorm(sample_size, mean = 55)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- rnorm(sample_size, mean = 68)  # контрольная группа

```

## Решение

H0: в группе альтернативного лечения отсутствует вероятностное доминирование относительно группы стандартного лечения и наоборот

Н1: в группе альтернативного лечения есть вероятностное доминирование относительно группы стандартного лечения и наоборот

Установим уровень значимости α=0.05

Используем тест Манна-Уитни-Уилкоксона

W = 0, p-value < 2.2e-16

95 percent confidence interval:
 -5.107566 -4.472636

Отвергаем Н0 в пользу Н1

В исследовании показано, что применение альтернативного метода лечения для пациентов с биполярным расстройством статистически значимо уменьшит симптомы депрессии более чем на 12%. Практическая значимость зависит от опросника.

```{r}

 wilcox.test(group1, group2, alternative = "two.sided", conf.int=TRUE)

```


# Гипотеза 7. Длительность сна (в часах) ассоциирована с уровенем стресса у студентов (шкала с нормальным распределением)

## Генерация данных  

```{r}

library(mvtnorm) # библиотека mvtnorm для работы с многомерным нормальным распределением

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 100

# Средние значения для длительности сна (HoursOfSleep) и уровня стресса (StressLevel) в популяции
means <- c(7, 5)  

# Матрица ковариации. В ислледуемой популяции HoursOfSleep и StressLevel ассоциированы отрицательно (r = -0.5)
cov_matrix <- matrix(c(1, -0.5, -0.5, 1), nrow = 2)

df <- rmvnorm(n = sample_size, 
              mean = means, 
              sigma = cov_matrix) %>% 
      as_tibble() %>%
      setNames(c("HoursOfSleep", "StressLevel"))  

```
## Решение (дополните решение визуализацией)

Н0: отсутствует взаимосвязь между длительностью сна и уровнем стресса

Н1: имеется взаимосвязь между длительностью сна и уровнем стресса

Можно посмотреть зависимость между переменными на диаграмме рассеяния: видна отрицательная корреляция между часами сна и уровнем стресса

Так как корреляция линейная, без явных выбросов, то используем метод Пирсона

Установим уровень значимости α=0.05

t = -6.0621, df = 98, p-value = 2.511e-08

cor 
-0.5222265

95 percent confidence interval:
 -0.6517877 -0.3630480

p-value<0.05, ДИ не включает ноль, следовательно, отвергаем Н0 в пользу Н1

Имеется статистически значимая отрицательная корреляция между длительностью сна и уровнем стресса.


```{r}
# Scatterplot

ggplot(df, aes(x=HoursOfSleep, y=StressLevel))+
  geom_point()+
  geom_smooth(method = "lm")+
  theme_bw()

hyp7 <- cor.test(df$HoursOfSleep, df$StressLevel, method = "pearson")
print(hyp7)

```
