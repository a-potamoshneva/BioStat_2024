---
title: "Classic_stat_tests"
author: "Anastasiia Potamoshneva"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(rcompanion)

```

# Инструкции

Ниже приведены семь клинических (исследовательских) гипотез. В качестве задания протестируйте их, используя соответствующие статистические критерии. Решение должно содержать все элементы алгоритма проверки статистических гипотез:

• Сформулируете нулевую и альтернативную гипотезы.
• Укажите уровень значимости α.
• Определите статистический тест (критерий) для проверки гипотезы. При необходимости аргументируйте выбор одностороннего теста. 
• Укажите критическое значение статистики (используйте распределения из материалов лекции).
• Определите наблюдаемое значение статистики.
• Оцените статистическую значимость (p-value и/или доверительный интервал).
• Оцените практическую значимость.


* Решение необходимо загружать в формате Rmd (воспроизводимый код).
** Данные для анализа необходимо генерировать самостоятельно в соответствии с каждой представленной гипотезой. По возможности используйте пакет dplyr
*** Предусмотрен мягкий дедлайн (17 ноября). В этом случае вы получите комментарии с возможностью повысить оценку. Сдача работы после жёсткого дедлайна (24 ноября) предусматривает снижение оценки (10 баллов).


# Гипотеза 1. Существует ассоциация между уровнем физической активности (бинарная переменная, физическая активность может быть 'высокой' и 'низкой') и частотой возникновения сердечно-сосудистых заболеваний у пациентов старше 50 лет. Попробуйте вариант с большими выборками (sample_size <- 100). Как изменится стратегия при малых выборках (sample_size <- 30) ? 

## Генерация данных

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки 
sample_size <- 100

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity <- sample(c(rep(x = "Высокая", times = sample_size/2), rep(x = "Низкая", times = sample_size/2)))

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

cardio <- ifelse(activity == "Высокая", rbinom(sample_size/2, 1, 0.5), rbinom(sample_size/2, 1, 0.6))

hyp1_large <- data.frame(activity = activity, cardio = cardio) %>% 
  mutate(activity = as.factor(activity), cardio = as.factor(cardio)) %>% 
  glimpse()

```


```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size_small <- 30

# Генерация данных по физической активности (бинарная переменная) в фиксированном соотношении 1:1
activity_small <- sample(c(rep(x = "Высокая", times = sample_size_small/2), rep(x = "Низкая", times = sample_size_small/2)))

# Генерация данных по наличию сердечно-сосудистых заболеваний (бинарная переменная)
# У активных людей меньше вероятность заболеть (0.5 vs 0.6)

cardio_small <- ifelse(activity_small == "Высокая", rbinom(sample_size_small/2, 1, 0.5), rbinom(sample_size_small/2, 1, 0.6))

hyp1_small <- data.frame(activity_small = activity_small, cardio_small = cardio_small) %>% 
  mutate(activity_small = as.factor(activity_small), cardio_small = as.factor(cardio_small)) %>% 
  glimpse()
    
```


## Решение

Гипотеза Н0: отсутствует ассоциация между физ.активностью и частотой ССЗ.

Гипотеза Н1: имеется ассоциация между физ.активностью и частотой ССЗ.

Установим уровень значимости α=0.05.

На большой выборке используем тест хи-квадрат:

Критическое значение статистики 3.84

Наблюдаемое значение статистики 4.20

Наблюдаемое значение больше критического, следовательно, оно находится вне зоны нулевой гипотезы

p-value=0.04

Следовательно, мы можем отклонить Н0 в пользу Н1.

На малой выборке используем вариант хи-квадрат с Монте Карло:

Критическое значение статистики 3.84

Наблюдаемое значение статистики 0.13

p-value = 1

Следовательно, мы не можем отклонить Н0.

Было показано, что физическая активность статистически значимо ассоциирована с частотой ССЗ только в большой выборке.

Можем оценить размер эффекта в большой выборке с помощью RR и RD:

Риск наличия ССЗ в группе высокой активности: 25/50=0.50

Риск наличия ССЗ в группе низкой активности: 36/50=0.72

RR=0.50/0.72=0.7 (Следовательно, риск наличия ССЗ в группе высокой активности меньше на 30% по сравнению с группой низкой активности)

RD=0.50-0.72=-0.22 (Следовательно, абсолютный риск наличия ССЗ в группе высокой активности меньше на 22% по сравнению с группой низкой активности)

Практическая значимость: у пациентов старше 50 лет с высокой физической активностью значительно снижается риск ССЗ, высокая физ.активность может использоваться как метод профилактики ССЗ.


```{r large_sample}
# Создание таблиц сопряженности
table_large <- table(hyp1_large$activity, hyp1_large$cardio)
rownames(table_large) <- c("Высокая активность", "Низкая активность")
colnames(table_large) <- c("Нет ССЗ", "Есть ССЗ")
print(table_large)

# Расчет хи-квадрата
chi_large <- chisq.test(table_large)
print(chi_large)

# Расчет наблюдаемого значения хи-квадрат (замените на ваше фактическое наблюдаемое значение)
observed_chi_squared <- 4.20  # Замените на ваше реальное наблюдаемое значение

# Определение степеней свободы для распределения хи-квадрат
df <- 1  # Подстраивайте степени свободы по мере необходимости

# Создание последовательности значений x
x_values <- seq(0.01, 10, by = 0.01)  # Подстраивайте диапазон и шаг по мере необходимости

# Расчет значений PDF для распределения хи-квадрат
pdf_chi_squared <- dchisq(x_values, df)

# Квантили
quantiles <- c(0.05, 0.95)

# Расчет критических значений для распределения хи-квадрат
critical_value_lower <- qchisq(quantiles[1], df)
critical_value_upper <- qchisq(quantiles[2], df)


# Создание data frame для построения графика
pdf_data <- data.frame(x = x_values, Probability = pdf_chi_squared)

# Создание графика PDF для визуализации распределения хи-квадрат
ggplot(pdf_data, aes(x = x, y = Probability)) +
  geom_line(size = 1, color = "black") +
  labs(title = "PDF распределения хи-квадрат", x = "x", y = "Плотность вероятности") +
  theme_minimal() +
  geom_vline(xintercept = c(critical_value_lower, critical_value_upper, observed_chi_squared),
             linetype = c("solid", "solid", "dashed"),
             color = c("blue", "blue", "red"),
             size = c(2, 2, 2)) +
  annotate("text", x = critical_value_lower - 0.5, y = 0.1, label = sprintf("Q(%.3f)=%.2f", quantiles[1], critical_value_lower), hjust = 0, angle = 90) +
  annotate("text", x = critical_value_upper - 0.5, y = 0.1, label = sprintf("Q(%.3f)=%.2f", quantiles[2], critical_value_upper), hjust = 0, angle = 90) +
  annotate("text", x = observed_chi_squared - 0.5, y = 0.1, label = 'наблюдаемое', hjust = 0, angle = 90) +
  annotate("text", x = critical_value_upper - 1, y = 0.5, label = sprintf("df = %.0f", df), hjust = 0)

```

```{r small sample}

#Создание таблиц сопряженности
table_small <- table(hyp1_small$activity, hyp1_small$cardio)
rownames(table_small) <- c("Высокая активность", "Низкая активность")
colnames(table_small) <- c("Нет ССЗ", "Есть ССЗ")
print(table_small)

# Хи-квадрат с Монте Карло 

print(chisq.test(table_small, simulate.p.value = TRUE, B = 10000))
```


# Гипотеза 2. Применение нового метода лечения для пациентов с артериальной гипертензией приведет к уменьшению среднего артериального давления по сравнению с пациентами, получающими стандартное лечение.


## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки (в каждой группе)
sample_size <- 80


# В популяции c экспериментальным методом лечения средний уровень систолического артериального давления меньше (130 vs 135 mm) 
# Генерация данных для группы с новым методом лечения 
# Предположим, что sd=5 (но результат будет зависеть от величины sd)
group_exp <- rnorm(sample_size, mean = 130, sd = 5)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group_ctrl <- rnorm(sample_size, mean = 135, sd =5)  # контрольная группа

```

## Решение

Н0: средние уровни САД равны в двух группах

Н1: средний уровень САД в экспериментальной группе ниже по сравнению с контрольной

Установим уровень значимости α=0.05

Используем точный t-критерий для среднего по методу Уэлча (односторонний (левосторонний), так как нас интересует только снижение САД)

t = -5.53,

p-value < 6.572e-08

95 percent confidence interval:
     -Inf -3.066963
     
Отклоняем нулевую гипотезу в пользу альтернативной (p-value < 0.05, ДИ не включает 0)

В исследовании было показано статистически значимое снижение АД примерно на 5 мм рт.ст. по сравнению со стандартным методом при применении нового метода терапии.

Практическая значимость:  Снижение АД даже на 5 мм рт.ст. по сравнению с контрольным препаратом в популяции может играть значимую роль в профилактике осложнений, особенно в данном случае в экспериментальной группе, где САД на новом препарате было нормальным. Но необходимо учитывать и другие факторы: тип контрольного препарата, целевая группа пациентов, линия терапии, побочные эффекты. Необходимо больше информации про препараты и тип исследования.


```{r}
hyp2 <- t.test(group_exp, group_ctrl, alternative = "less", var.equal = FALSE)
print(hyp2)

sd(group_exp)

observed=-5.53

# cтепени свободы
sd_x = 5.4
nx   = 80
sd_y = 4.6
ny   = 80
numerator <- ((sd_x^2 / nx) + (sd_y^2 / ny))^2
denominator <- (sd_x^4 / (nx^2 * (nx - 1))) + (sd_y^4 / (ny^2 * (ny - 1)))

df <- numerator / denominator

df # 154

# значения по оси x
x_values <- seq(-4, 4, by = 0.01)  # Adjust the range and step size as needed

# PDF значения для распределения t
pdf_t <- dt(x_values, df)

# Квантили
quantiles <- c(0.05, 1)

t_critical_low <- qt(quantiles[1], df = df)
t_critical_up <-  qt(quantiles[2], df = df)

# создание базы данных
pdf_data <- data.frame(x = x_values, Probability = pdf_t)

# Создание графика PDF для визуализации стандартного нормального распределения
ggplot(pdf_data, aes(x = x)) +
  geom_line(aes(y = Probability), linewidth = 1, color = "black", linetype = "solid") +
  geom_vline(xintercept = t_critical_low, linewidth = 2, linetype = "solid", color = "blue") +
  geom_vline(xintercept = t_critical_up, linewidth = 2, linetype = "solid", color = "blue") +
  geom_vline(xintercept = observed, linewidth = 2, linetype = "dashed", color = "red") +
  annotate("text", x = t_critical_low-0.15, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[1], t_critical_low), hjust = 0, angle = 90) +
  annotate("text", x = t_critical_up-0.15, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[2], t_critical_up), hjust = 0, angle = 90) +
  annotate("text", x = observed-0.15, y = 0.2, label = 'observed', hjust = 0, angle = 90)+
  annotate("text", x = 2.5, y = 0.4, label = sprintf("df(%.0f)", df), hjust = 0)+
  labs(title = "PDF распределения Стьюдента", x = "x", y = "Плотность вероятности")


```


# Гипотеза 3. Внедрение программы реабилитации для пациентов с хронической болью в спине приведет к улучшению их физической активности (предположим что физическую активность можно оценить по шкале 0-100)

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки 
sample_size <- 30

# В популяции до реабилитации средний уровень физической активности меньше (50 vs 60) 
# Генерация данных до реабилитации
before <- rbinom(sample_size, size = 100, prob = 0.5)

# Генерация данных после реабилитации
after <- rbinom(sample_size, size = 100, prob = 0.6)  


```

## Решение

Н0: отсутствует вероятностное доминирование между уровнями активности пациентов 

Н1: имеется вероятностное доминирование более высокого уровня активности пациентов 

Установим уровень значимости α=0.05

Используем тест Уилкоксона для зависимых выборок (односторонняя (правосторонняя) гипотеза, так как интересует только повышение уровня активности)

p-value = 5.576e-06

95 percent confidence interval:
 8.499972       Inf
 
 sample estimates:
(pseudo)median 
      10.99999 
 
Отклоняем нулевую гипотезу в пользу альтернативной (p-value<0.05, ДИ не включает ноль)

В исследовании было показано статистически значимое увеличение показателя физической активности на 10 баллов. 

Практическая значимость: зависит от шкалы, изначального состояния и перехода пациентов между тяжестями заболевания (например, у человека физическая активность может измениться со средней на высокую или со средней на среднюю, что будет иметь разную интерпретацию). При доказательстве клинической значимости можно использовать программу реабилитации для улучшения состояния. 

```{r}
hyp3 <- wilcox.test(after, before, paired = TRUE, exact= FALSE, conf.int=TRUE, alternative = "greater")
print(hyp3)

```

# Гипотеза 4. Применение нового метода лечения для пациентов с инфарктом миокарда увеличит долю вернувшихся к нормальной физической активности 

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Общий размер выборки
sample_size <- 200


# В популяции экспериментального лечения вероятность нормальной физической активности больше (0.7 vs 0.65)
# Генерация данных по статусу лечение (бинарная переменная, новый метод или стандарт) в фиксированном соотношении 1:1
treatment <- sample(c(rep(x = "новый метод", times = sample_size/2), rep(x = "стандарт", times = sample_size/2)))

# Генерация данных по физической активности после лечения (бинарная переменная)
activity <- ifelse(treatment == "новый метод", rbinom(sample_size/2, 1, 0.7), rbinom(sample_size/2, 1, 0.65))
    
```

## Решение

Н0: доля пациентов с нормальной физ.активностью одинакова в обеих группах

Н1: доля пациентов с нормальной физ.активностью выше в группе нового метода лечения

Установим уровень значимости α=0.05

Используем асимптотический Z-критерий для разности долей для независимых выборок (односторонний (правосторонний), так как интересует только повышение активности) 

Установим уровень значимости α=0.05

Z-score = 0.47, p-value = 0.32
 
Следовательно, мы не можем отклонить нулевую гипотезу
 
Практическая значимость: новый метод лечения не увеличивает долю вернувшихся к нормальной активности пациентов. Клинически применение такого метода не обусловлено.

```{r}
# Создадим таблицу сопряженности
table_activity <- table(treatment, activity)
print(table_activity)

# Функция для проведения z-теста для двух независимых долей
performTwoProportionZTest <- function(n1, x, n2, y) {
  # Расчет долей успешных исходов в выборках
  p1 <- x / n1
  p2 <- y / n2

  # Расчет объединенной доли успешных исходов
  P <- (x + y) / (n1 + n2)

  # Расчет стандартной ошибки
  SQ <- P * (1 - P) * (1/n1 + 1/n2)

  # Выполнение z-теста
  z_test_result <- (p1 - p2) / sqrt(SQ)

  return(z_test_result)
}

# Использование функции:
n1 <- 100  # Общее количество попыток для выборки 1
x <- 72   # Количество успешных исходов для выборки 1

n2 <- 100  # Общее количество попыток для выборки 2
y <- 69   # Количество успешных исходов для выборки 2

z_test_result <- performTwoProportionZTest(n1, x, n2, y)
print(z_test_result)

p_value <- 1 - pnorm(z_test_result)

observed <-  0.47
# Создание последовательности значений x
x_values <- seq(-4, 4, by = 0.01)

# Расчет значений Плотности Вероятности (PDF) для стандартного нормального распределения
pdf_normal <- dnorm(x_values, mean = 0, sd = 1)

# Квантили
quantiles <- c(0, 0.95)

quantile_values <- qnorm(quantiles, mean = 0, sd = 1)

# Создание данных для построения графика
pdf_data <- data.frame(x = x_values, Probability = pdf_normal)

# Создание графика PDF для визуализации стандартного нормального распределения
ggplot(pdf_data, aes(x = x)) +
  geom_line(aes(y = Probability), linewidth = 1, color = "black", linetype = "solid") +
  geom_vline(xintercept = quantile_values, linewidth = 1, linetype = "solid", color = "blue") +
  geom_vline(xintercept = observed, linewidth = 1, linetype = "dashed", color = "red") +
  annotate("text", x = quantile_values[1]-0.2, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[1], quantile_values[1]), hjust = 0, angle = 90) +
  annotate("text", x = quantile_values[2]-0.2, y = 0.2, label = sprintf("Q(%.3f)=%.2f", quantiles[2], quantile_values[2]), hjust = 0, angle = 90) +
  annotate("text", x = observed-0.2, y = 0.1, label = 'observed', hjust = 0, angle = 90)+
  labs(title = "PDF стандартного нормального распределения", x = "x", y = "Плотность вероятности")

```

# Гипотеза 5. Применение медитации в течение 8 недель повлияет на наличие стресса (есть/нет) у лиц с высоким уровнем тревожности.

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 50

# Генерация данных до медитации (бинарная переменная) в фиксированном соотношении 1:1
before <- sample(c(rep(x = 1, times = sample_size/2), rep(x = 0, times = sample_size/2)))

# Генерация данных после медитации (бинарная переменная). После медитации вероятность наличия стресса меньше (0.2 vs 0.4)
after <- before
after[before == 1] <- rbinom(sum(before == 1), 1, 0.4)
after[before == 0] <- rbinom(sum(before == 0), 1, 0.2)

```
Насколько поняла, нужно было сгенерировать изначально поровну, а затем при отсутствии стресса до-стресс с вероятностью 0.2, наличии стресса до-0.4 после, в остальных случаях-отсутствие стресса (0.6)

## Решение

H0: Доли пациентов со стрессом до медитации и после медитации одинаковы

H1: Доли пациентов со стрессом до медитации и после медитации различны

Установим уровень значимости α=0.05

Используем тест Мак-Немара для повторных измерений

p-value = 0.007963

Мы можем отклонить гипотезу Н0 в пользу Н1

В исследовании показано наличие статистически значимого снижения уровня стресса после медитации. 

Практическая значимость: медитация в исследовании показала значимый эффект на снижение тревоги. Метод может применяться в дальнейшем в клинике.


```{r}

hyp5 <- tibble(before=before, after=after)
table_stress <- table(hyp5$before, hyp5$after)

rownames(table_stress) <- c("Нет стресса (до)", "Есть стресс (до)")
colnames(table_stress) <- c("Нет стресса (после)", "Есть стресс(после)")
print(table_stress)

mcnemar <- mcnemar.test(table_stress)
print(mcnemar)

```

# Гипотеза 6. Применение альтернативного метода лечения для пациентов с биполярным расстройством приведет к значимому изменению уровня симптомов депрессии по отношению к группе, прошедшей стандартное лечение (депрессию можно определить по шкале от 0 до 100, при этом исследователь должен избегать любых предположений (кроме i.i.d.)).

## Генерация данных 

```{r}

# Воспроизводимость результатов
set.seed(42)

# Размер выборки для каждой группы
sample_size <- 20


# В популяции c экспериментальным методом лечения среднее депрессии меньше (55 vs 68) 
# Генерация данных для экспериментальной группы 
group1 <- round(rnorm(sample_size, mean = 55),0)  # экспериментальная группа

# Генерация данных для группы со стандартным лечением
group2 <- round(rnorm(sample_size, mean = 68),0)  # контрольная группа

```

## Решение

H0: в группе альтернативного лечения отсутствует вероятностное доминирование относительно группы стандартного лечения и наоборот

Н1: в группе альтернативного лечения есть вероятностное доминирование относительно группы стандартного лечения и наоборот

Установим уровень значимости α=0.05

Используем тест Манна-Уитни-Уилкоксона

p-value = 5.189e-08

95 percent confidence interval:
 -13.99999 -11.99995
 
 difference in location 
             -12.99997 

Отвергаем Н0 в пользу Н1 (p-value<0.05, ДИ не включает 0)

В исследовании показано, что применение альтернативного метода лечения для пациентов с биполярным расстройством статистически значимо уменьшит симптомы депрессии более чем на 12%. 

Практическая значимость: Необходима клиническая интерпретация согласно опроснику. Если 12% уменьшение симптомов клинически значимо, то метод может быть эффективным при лечении пациентов с БАР. Также оценим размер эффекта с помощью rang biserial test: rg=-1, следовательно, группа 2 полностью доминирует над 1-сильные отличия между группами.

```{r}
combined <- c(group1, group2)
group <- factor(c(rep("group1", length(group1)), rep("group2", length(group2))))
wilcoxonRG(combined, group, ci=TRUE)
```


```{r}

 wilcox.test(group1, group2, alternative = "two.sided", conf.int=TRUE, exact=FALSE)

```


# Гипотеза 7. Длительность сна (в часах) ассоциирована с уровенем стресса у студентов (шкала с нормальным распределением)

## Генерация данных  

```{r}

library(mvtnorm) # библиотека mvtnorm для работы с многомерным нормальным распределением

# Воспроизводимость результатов
set.seed(42)

# Размер выборки
sample_size <- 100

# Средние значения для длительности сна (HoursOfSleep) и уровня стресса (StressLevel) в популяции
means <- c(7, 5)  

# Матрица ковариации. В ислледуемой популяции HoursOfSleep и StressLevel ассоциированы отрицательно (r = -0.5)
cov_matrix <- matrix(c(1, -0.5, -0.5, 1), nrow = 2)

df <- rmvnorm(n = sample_size, 
              mean = means, 
              sigma = cov_matrix) %>% 
      as_tibble() %>%
      setNames(c("HoursOfSleep", "StressLevel"))  

```
## Решение (дополните решение визуализацией)

Н0: отсутствует взаимосвязь между длительностью сна и уровнем стресса

Н1: имеется взаимосвязь между длительностью сна и уровнем стресса

Можно посмотреть зависимость между переменными на диаграмме рассеяния: видна отрицательная корреляция между часами сна и уровнем стресса

Так как корреляция линейная, без явных выбросов, то используем метод Пирсона

Установим уровень значимости α=0.05

t = -6.0621, df = 98, p-value = 2.511e-08

cor 
-0.5222265

95 percent confidence interval:
 -0.6517877 -0.3630480

p-value<0.05, ДИ не включает ноль, следовательно, отвергаем Н0 в пользу Н1

Имеется статистически значимая отрицательная корреляция между длительностью сна и уровнем стресса.

Практическая значимость: длительность сна отрицательно коррелирует с уровнем стресса студентов, что имеет клиническую значимость, например, это может использоваться в дальнейшем в рекомендациях по профилактике и терапии стресса у студентов.


```{r}
# Scatterplot

ggplot(df, aes(x=HoursOfSleep, y=StressLevel))+
  geom_point()+
  geom_smooth(method = "lm")+
  theme_bw()

hyp7 <- cor.test(df$HoursOfSleep, df$StressLevel, method = "pearson")
print(hyp7)

```
